<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WFL Control Panel</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    h1 { color: #e94560; text-align: center; margin-bottom: 20px; font-size: 2.5rem; }
    .status {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
    }
    .connected { background: #1db954; }
    .disconnected { background: #e94560; }
    .panel {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .panel h2 { color: #e94560; margin-bottom: 15px; font-size: 1.3rem; }
    .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
    button {
      background: #e94560;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    button:hover { background: #ff6b6b; transform: translateY(-2px); }
    button:active { transform: translateY(0); }
    button.secondary { background: #4a4a6a; }
    button.secondary:hover { background: #5a5a7a; }
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3);
      color: white;
      font-size: 14px;
      margin-bottom: 10px;
    }
    input::placeholder { color: rgba(255,255,255,0.5); }
    .slider-container { margin: 10px 0; }
    .slider-container label { display: block; margin-bottom: 5px; color: #aaa; }
    input[type="range"] {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      background: #4a4a6a;
      border-radius: 4px;
      margin: 10px 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #e94560;
      border-radius: 50%;
      cursor: pointer;
    }
    .value-display { color: #e94560; font-weight: bold; }
    .log {
      background: #0a0a15;
      border-radius: 8px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry { padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .log-entry.incoming { color: #1db954; }
    .log-entry.outgoing { color: #e94560; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; color: #aaa; }
    .char-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
    .char-buttons button { flex: 1; }
    .char-buttons button.active { background: #1db954; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, createContext, useContext } = React;

    const getToken = () => {
      try {
        return new URLSearchParams(window.location.search).get('token') || '';
      } catch {
        return '';
      }
    };

    const withToken = (url) => {
      const token = getToken();
      if (!token) return url;
      const joiner = url.includes('?') ? '&' : '?';
      return `${url}${joiner}token=${encodeURIComponent(token)}`;
    };

    // WebSocket Context
    const WebSocketContext = createContext(null);

    function WebSocketProvider({ children }) {
      const [socket, setSocket] = useState(null);
      const [connected, setConnected] = useState(false);
      const [logs, setLogs] = useState([]);
      const reconnectTimeout = useRef(null);

      const addLog = (message, type = 'info') => {
        setLogs(prev => [...prev.slice(-50), { message, type, time: new Date().toLocaleTimeString() }]);
      };

      const connect = () => {
        // Dynamic WebSocket URL - same origin, port 3000
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const baseWsUrl = `${wsProtocol}//${window.location.hostname}:3000`;
        const wsUrl = withToken(baseWsUrl);

        addLog(`Connecting to ${wsUrl}...`, 'info');

        const ws = new WebSocket(wsUrl);

        ws.addEventListener('open', () => {
          setConnected(true);
          addLog('Connected!', 'incoming');
          // Identify this client type to the server
          try {
            ws.send(JSON.stringify({ type: 'web-hello' }));
          } catch {
            // ignore
          }
          if (reconnectTimeout.current) {
            clearTimeout(reconnectTimeout.current);
          }
        });

        ws.addEventListener('message', (event) => {
          try {
            const data = JSON.parse(event.data);
            addLog(`← ${data.command || data.type}: ${JSON.stringify(data).slice(0, 100)}`, 'incoming');
            // Handle roast and other commands
            roastHandler(data);
          } catch (e) {
            addLog(`← Raw: ${event.data}`, 'incoming');
          }
        });

        ws.addEventListener('close', () => {
          setConnected(false);
          addLog('Disconnected. Reconnecting in 5s...', 'info');
          reconnectTimeout.current = setTimeout(connect, 5000);
        });

        ws.addEventListener('error', (error) => {
          addLog(`Error: ${error.message || 'Connection failed'}`, 'info');
        });

        setSocket(ws);
      };

      const send = (data) => {
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(data));
          addLog(`→ ${JSON.stringify(data).slice(0, 100)}`, 'outgoing');
        }
      };

      // Roast handler - process incoming roast commands
      const roastHandler = (data) => {
        if (data.command === 'roast') {
          console.log('Roast received:', data.target, data.footage);
          // Could trigger UI updates here
        }
      };

      useEffect(() => {
        connect();
        return () => {
          if (socket) socket.close();
          if (reconnectTimeout.current) clearTimeout(reconnectTimeout.current);
        };
      }, []);

      return (
        <WebSocketContext.Provider value={{ socket, connected, send, logs }}>
          {children}
        </WebSocketContext.Provider>
      );
    }

    function useWebSocket() {
      return useContext(WebSocketContext);
    }

    // Main App Component
    function App() {
      const { connected, send, logs } = useWebSocket();
      const [character, setCharacter] = useState('terry');
      const [lipShape, setLipShape] = useState(0);
      const [headAngle, setHeadAngle] = useState(0);
      const [roastName, setRoastName] = useState('');
      const [roastUrl, setRoastUrl] = useState('');

      const sendRive = (input, value) => {
        fetch(withToken(`/terry/${input}?${input === 'lip' ? 'shape' : 'angle'}=${value}`));
      };

      const sendCommand = (endpoint) => {
        fetch(withToken(endpoint)).then(r => r.json()).then(console.log);
      };

      const submitRoast = (e) => {
        e.preventDefault();
        fetch(withToken('/submit'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: roastName, video: roastUrl, character, token: getToken() || undefined })
        }).then(r => r.json()).then(data => {
          console.log('Roast submitted:', data);
          setRoastName('');
          setRoastUrl('');
        });
      };

      return (
        <div className="container">
          <h1>WFL Control Panel</h1>

          <div className={`status ${connected ? 'connected' : 'disconnected'}`}>
            {connected ? 'CONNECTED' : 'DISCONNECTED'}
          </div>

          {/* Character Select */}
          <div className="panel">
            <h2>Character</h2>
            <div className="char-buttons">
              <button
                className={character === 'terry' ? 'active' : 'secondary'}
                onClick={() => setCharacter('terry')}
              >
                Terry
              </button>
              <button
                className={character === 'nigel' ? 'active' : 'secondary'}
                onClick={() => setCharacter('nigel')}
              >
                Nigel
              </button>
            </div>
          </div>

          {/* Lip Controls */}
          <div className="panel">
            <h2>Mouth Shape</h2>
            <div className="slider-container">
              <label>Lip Shape: <span className="value-display">{lipShape}</span></label>
              <input
                type="range"
                min="0"
                max="7"
                value={lipShape}
                onChange={(e) => {
                  setLipShape(e.target.value);
                  sendCommand(`/${character}/lip?shape=${e.target.value}`);
                }}
              />
            </div>
            <div className="controls">
              {[0,1,2,3,4,5,6,7].map(shape => (
                <button
                  key={shape}
                  className="secondary"
                  onClick={() => {
                    setLipShape(shape);
                    sendCommand(`/${character}/lip?shape=${shape}`);
                  }}
                >
                  Shape {shape}
                </button>
              ))}
            </div>
          </div>

          {/* Head Controls */}
          <div className="panel">
            <h2>Head Turn</h2>
            <div className="slider-container">
              <label>Angle: <span className="value-display">{headAngle}°</span></label>
              <input
                type="range"
                min="-40"
                max="40"
                value={headAngle}
                onChange={(e) => {
                  setHeadAngle(e.target.value);
                  sendCommand(`/${character}/head?angle=${e.target.value}`);
                }}
              />
            </div>
          </div>

          {/* Quick Actions */}
          <div className="panel">
            <h2>Animations</h2>
            <div className="controls">
              <button onClick={() => sendCommand(`/${character}/talk?on=true`)}>
                Start Talking
              </button>
              <button onClick={() => sendCommand(`/${character}/talk?on=false`)}>
                Stop Talking
              </button>
              <button onClick={() => sendCommand(`/speak?character=${character}&text=Hello%20World`)}>
                Say "Hello"
              </button>
              <button onClick={() => sendCommand(`/shake?character=${character}&intensity=20`)}>
                Shake Head
              </button>
              <button onClick={() => sendCommand(`/nod?character=${character}`)}>
                Nod
              </button>
              <button onClick={() => sendCommand('/reset')}>
                Reset All
              </button>
            </div>
          </div>

          {/* Look Direction */}
          <div className="panel">
            <h2>Look Direction</h2>
            <div className="controls">
              <button className="secondary" onClick={() => sendCommand('/look?direction=upleft')}>↖</button>
              <button className="secondary" onClick={() => sendCommand('/look?direction=up')}>↑</button>
              <button className="secondary" onClick={() => sendCommand('/look?direction=upright')}>↗</button>
              <button className="secondary" onClick={() => sendCommand('/look?direction=left')}>←</button>
              <button onClick={() => sendCommand('/look?direction=center')}>●</button>
              <button className="secondary" onClick={() => sendCommand('/look?direction=right')}>→</button>
              <button className="secondary" onClick={() => sendCommand('/look?direction=downleft')}>↙</button>
              <button className="secondary" onClick={() => sendCommand('/look?direction=down')}>↓</button>
              <button className="secondary" onClick={() => sendCommand('/look?direction=downright')}>↘</button>
            </div>
          </div>

          {/* Nigel Eyes */}
          {character === 'nigel' && (
            <div className="panel">
              <h2>Nigel's Eyes</h2>
              <div className="controls">
                <button onClick={() => sendCommand('/nigel/eyes?state=open')}>Open</button>
                <button onClick={() => sendCommand('/nigel/eyes?state=closed')}>Closed</button>
                <button onClick={() => sendCommand('/nigel/eyes?state=half')}>Half</button>
                <button onClick={() => sendCommand('/nigel/eyes?state=squint')}>Squint</button>
                <button onClick={() => sendCommand('/nigel/eyes?state=wide')}>Wide</button>
              </div>
            </div>
          )}

          {/* Direct Animation Control */}
          <div className="panel">
            <h2>Direct Animations</h2>
            <p style={{color: '#888', fontSize: '12px', marginBottom: '10px'}}>
              For Rive files without State Machine inputs
            </p>
            <div className="controls">
              <button className="secondary" onClick={() => sendCommand('/anims')}>
                List Anims
              </button>
              <button onClick={() => sendCommand('/anim/play?name=nigel_head_shake')}>
                Nigel Head Shake
              </button>
              <button onClick={() => sendCommand('/anim/play?name=terry_talk')}>
                Terry Talk
              </button>
              <button onClick={() => sendCommand('/anim/play?name=idle')}>
                Idle
              </button>
              <button className="secondary" onClick={() => {
                const name = prompt('Animation name to play:');
                if (name) sendCommand(`/anim/play?name=${encodeURIComponent(name)}`);
              }}>
                Play Custom...
              </button>
              <button className="secondary" onClick={() => {
                const name = prompt('Animation name to stop:');
                if (name) sendCommand(`/anim/stop?name=${encodeURIComponent(name)}`);
              }}>
                Stop Custom...
              </button>
            </div>
          </div>

          {/* Roast Submit */}
          <div className="panel">
            <h2>Submit Roast</h2>
            <form onSubmit={submitRoast}>
              <div className="form-group">
                <label>Target Name</label>
                <input
                  type="text"
                  placeholder="Who we roasting?"
                  value={roastName}
                  onChange={(e) => setRoastName(e.target.value)}
                  required
                />
              </div>
              <div className="form-group">
                <label>Audio/Video URL</label>
                <input
                  type="url"
                  placeholder="https://..."
                  value={roastUrl}
                  onChange={(e) => setRoastUrl(e.target.value)}
                  required
                />
              </div>
              <button type="submit">ROAST 'EM</button>
            </form>
          </div>

          {/* Connection Log */}
          <div className="panel">
            <h2>WebSocket Log</h2>
            <div className="log">
              {logs.map((log, i) => (
                <div key={i} className={`log-entry ${log.type}`}>
                  [{log.time}] {log.message}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // Render
    ReactDOM.createRoot(document.getElementById('root')).render(
      <WebSocketProvider>
        <App />
      </WebSocketProvider>
    );
  </script>
</body>
</html>
